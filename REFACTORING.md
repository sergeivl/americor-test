# Рефакторинг

> Какие проблемы вы считаете первостепенными.

## Проблемы и их решения

### Неоптимальный алгоритм экспорта данных в csv файл. 
Для формирования csv файла используется модуль kartik-v/yii2-export.
Он использует PHPOffice/PhpSpreadsheet для генерации csv файла.  
Применял ранее пакет PhpSpreadsheet для генерации «Универсального передаточного документа» 
в рамках CRM/ERP системы - он слишком ресурсозатратный. Для генерации csv файла
считаю его использование нецелесообразным, с учетом того, что объем данных будут расти.

А используемый подход к формированию csv контента съедает много оперативной памяти,
а при большом объеме данным может привести к тому, что мы упремся в memory limit.

#### Решение
1. Отказаться от генерации контента с помощью модуля kartik-v/yii2-export
2. Отказаться от генерации csv контента в рамках http запроса
3. Реализовать генерацию csv в очереди, установив и использовав модуль yiisoft/yii2-queue
4. При работе с ActiveQuery использовать метод `batch()` для экономии оперативной памяти
5. Получать результаты выполнения запросов в виде массива со строками вместо массива с ActiveRecord (для экономии оперативной памяти)
6. Создать файл и построчно записывать csv строки в него, затем его содержимое пользователю
7. Идея для дальнейшей доработки: можно учесть сценарий, когда разные пользователи делают запрос на формирования экспорта по тем же критериям. Можно проверять, что если запрос сделан с теми же критериями и состояние этих данных в БД не изменилось - можно отдавать ему ранее сгенерированный файл
---

### Длительный по времени процесс выполняется в рамках http запроса

При клике по кнопке происходит выполнение GET запроса, который "блокирует" вкладку в браузере до тех пор,
пока запрос не вернет результат.

#### Решение
1. По части frontend первым запросом отправлять команду на запуск Job, 
2. Последующими асинхронными запросами проверять статус Job средствами JavaScript (например раз в 3 секунды)
3. После успешного завершения Job-ы делать переадресацию на роут, который отдаст файл
4. По UI - сделать блокировку кнопки и отображение иконки анимации. Кнопка разблокируется, а анимация исчезает при завершении задачи.  
5. Предложение по дальнейшим улучшениям: можно не ограничиваться одной страницей и позволить пользователю переключаться на другие страницы сайта, 
   при это при наличии незавершенных Job-ах, запущенных пользователем также будут выполняться асинхронные запросы,
   а по готовности отображать Flash сообщение со ссылкой на файл.
   
---

### Устаревшие пакеты
С целью увеличения производительности желательно обновить все пакеты до последних стабильных версий.
Если нет каких-нибудь "легаси" модулей или несовместимого с новой версии PHP кода - то лучше обновить.

#### Решение
1. Обновить версию `php` до `8.0` и выставить свежие версии пакетов в `composer.json` 
2. В docker-compose заменить образ на `yiisoftware/yii2-php:8.0-apache`
